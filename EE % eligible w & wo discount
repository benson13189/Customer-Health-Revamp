select 
stores,
total_eligible as "Total Eligible Transactions",
eligible_with_discount as "Count Eligible with Discount",
(eligible_with_discount / total_eligible) * 100 as "Percent Eligible with Discount",
eligible_no_discount as "Count Eligible no Discount",
(eligible_no_discount / total_eligible) * 100 as "Percent Eligible no Discount",
case
    when "Percent Eligible with Discount" between '90' and '100' then 3
    when "Percent Eligible with Discount" between '80' and '89' then 2
    when "Percent Eligible with Discount" between '70' and '79' then 1
    Else 0 end as "New CHO"
from
(Select 
distinct(store_id) as stores,
sum(case
    when eligibility_flag = 'TRUE' and units_sold_with_discount >= '1' then 1 else 0 end) as eligible_with_discount,
sum(case
    when eligibility_flag = 'TRUE' and units_sold_with_discount < '1' then 1 else 0 end) as eligible_no_discount,
sum(case
    when eligibility_flag = 'TRUE' then 1 else 0 end) as total_eligible

from "PROD"."RETAILER_PERFORMANCE"."ENGAGE_PROGRAM_ELIGIBILITY_RESULTS"
where
day(timestamp) >= day(dateadd('day',-30,getdate()))
group by stores
)
where total_eligible != '0'
order by "Percent Eligible with Discount" desc
