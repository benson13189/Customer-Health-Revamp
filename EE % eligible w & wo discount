select 
stores,
eligible_with_discount,
(eligible_with_discount / total_eligible) * 100 as Percent_Eligible_Taken,
eligible_no_discount,
(eligible_no_discount / total_eligible) * 100 as Percent_Eligbile_Missed,
total_eligible

from
(Select 
distinct(store_id) as stores,
sum(case
    when eligibility_flag = 'TRUE' and units_sold_with_discount >= '1' then 1 else 0 end) as eligible_with_discount,
sum(case
    when eligibility_flag = 'TRUE' and units_sold_with_discount < '1' then 1 else 0 end) as eligible_no_discount,
sum(case
    when eligibility_flag = 'TRUE' then 1 else 0 end) as total_eligible

from "PROD"."RETAILER_PERFORMANCE"."ENGAGE_PROGRAM_ELIGIBILITY_RESULTS"
where
day(timestamp) >= day(dateadd('day',-30,getdate()))
group by stores
)
where total_eligible != '0'
