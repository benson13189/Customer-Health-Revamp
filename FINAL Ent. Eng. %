select 
stores,
total_eligible as "Total Eligible Transactions",
eligible_with_discount as "Count Eligible with Discount",
case
    when "Total Eligible Transactions" > '0' then cast((eligible_with_discount / total_eligible) * 100 as number (10,0))
    when "Total Eligible Transactions" = '0' then 0
    end as "Percent Eligible with Discount",
case
    when bitand(bit_flag,1024)=1024 and "Percent Eligible with Discount" between '90' and '100' then 90
    when bitand(bit_flag,1024)=1024 and "Percent Eligible with Discount" between '80' and '89' then 80
    when bitand(bit_flag,1024)=1024 and "Percent Eligible with Discount" between '70' and '79' then 70
    when bitand(bit_flag,1024)=1024 and "Percent Eligible with Discount" between '60' and '69' then 60
    when bitand(bit_flag,1024)=1024 and "Percent Eligible with Discount" between '50' and '59' then 50
    when bitand(bit_flag,1024)=1024 and "Percent Eligible with Discount" between '40' and '49' then 40
    when bitand(bit_flag,1024)=1024 and "Percent Eligible with Discount" between '30' and '39' then 30
    when bitand(bit_flag,1024)=1024 and "Percent Eligible with Discount" between '20' and '29' then 20
    when bitand(bit_flag,1024)=1024 and "Percent Eligible with Discount" between '10' and '19' then 10
    when bitand(bit_flag,1024)=1024 and "Percent Eligible with Discount" between '0' and '9' then 0
    when bitand(bit_flag,1024)<>1024 then 0 
    Else 0 
    end as "Discounts Given Percentile",
customer_health_score__c as "Current CHO",
case
    when bitand(bit_flag,1024)=1024 and "Percent Eligible with Discount" >= '50' then 3
    when bitand(bit_flag,1024)=1024 and "Percent Eligible with Discount" between '35' and '49' then 2
    when bitand(bit_flag,1024)=1024 and "Percent Eligible with Discount" between '15' and '34' then 1
    when bitand(bit_flag,1024)=1024 and "Percent Eligible with Discount" <= '14' then 0
    when bitand(bit_flag,1024)<>1024 then 0 
    end as "New CHO",
bit_flag,
engage_purchased_at


from
(Select 
store_id as stores,
sfdc_account.customer_health_score__c as customer_health_score__c,
engage_status.engage_purchased_at as engage_purchased_at,
sum(case
    when eligibility_flag = 'TRUE' and units_sold_with_discount >= '1' then 1 else 0 end) as eligible_with_discount,
sum(case
    when eligibility_flag = 'TRUE' and units_sold_with_discount < '1' then 1 else 0 end) as eligible_no_discount,
sum(case
    when eligibility_flag = 'TRUE' then 1 else 0 end) as total_eligible,
engage_status.bit_flag

from "PROD"."RETAILER_PERFORMANCE"."ENGAGE_PROGRAM_ELIGIBILITY_RESULTS"
    join "PROD"."SALESFORCE"."ACCOUNT" as sfdc_account
        on store_id = store_id__c
    join "PROD"."APPDB"."STORES" as engage_status
        on stores = engage_status.id
where
timestamp >= dateadd('day',-30,getdate()) and --what timeframe do we want for EE tx's?
bitand(engage_status.bit_flag,1024)=1024 and
engage_status.last_tx_date_time is not null
group by stores,customer_health_score__c,bit_flag,engage_status.engage_purchased_at

)
order by "Total Eligible Transactions" asc
