SELECT 
  report_status.report_account_id as "Report ID",
  report_status.STORE_CHAIN_ID as "Chain ID",
  report_status.store_id as "Store ID",
  case when bitand(tsd_status.bit_flag,8192)=8192 and tsd_status.last_tx_date_time is not null then 'TSD Active'
       else 'TSD Inactive' end as "TSD Status",
  cast(report_status.PERIOD_END_AT as date) AS "Week-Ending Date",
    case webapi_report.report_type
      WHEN 0 THEN 'IRI'
      WHEN 4 THEN 'MSA'
      WHEN 1 THEN '???'
    Else 'NA'
    END AS "Report Type",
    case webapi_report.status
      WHEN 0 THEN 'not_ready' --store either has no data or data is incomplete--0
      WHEN 1 THEN 'ready_to_submit' --0
      WHEN 2 THEN 'generation_pending' --0
      WHEN 3 THEN 'submitted' --3 
      WHEN 4 THEN 'generation_failed' --0
      WHEN 5 THEN 'submission_failed' --0
      WHEN 6 THEN 'regenerate' --0
      WHEN 7 THEN 'force_submitted' --3
      WHEN 8 THEN 'submission_pending' --0
    Else 'NA'
    END as "Report Status",
    case report_status.status
      WHEN 0 THEN 'Validated'
      WHEN 1 THEN 'Resync'
      WHEN 2 THEN 'Refetch'
      WHEN 3 THEN 'Invalid'
      ELSE 'n/a'
    END as "Store Status",
 case when sfdc_account.customer_health_score__c is not null then sfdc_account.CUSTOMER_HEALTH_SCORE__C 
      when sfdc_account.customer_health_score__c is null then 'No Current CHO' end as "Current CHO",
 case when "Report Status" = 'force_submitted' then 3
      when "Report Status" = 'submitted' then 3
      when "Report Status" = 'not_ready' then 0
      when "Report Status" = 'ready_to_submit' then 0
      when "Report Status" = 'generation_pending' then 0
      when "Report Status" = 'sumbission_failed' then 0
      when "Report Status" = 'regenerate' then 0
      when "Report Status" = 'submission_pending' then 0
      end as "New CHO" -- finish calculating monthly avgs. 
      --100% = 3
      -->85% = 2
      -->75% = 1
      --<75% = 0
     
  FROM PROD.TSD.STORE_STATUS_PER_PERIOD as report_status
  Join "PC_STITCH_DB"."STITCH_R1000"."REPORTS" as webapi_report
  ON webapi_report.request_id = report_status.request_id
   join "PC_STITCH_DB"."STITCH_R1000"."REPORT_ACCOUNTS" as accounts
  ON report_status.report_account_id = accounts.id
  and webapi_report.report_type IN (0,4)
  join "PROD"."SALESFORCE"."ACCOUNT" as sfdc_account
  on "Store ID" = sfdc_account.store_id__c
  join "PROD"."APPDB"."STORES" as tsd_status
  on "Store ID" = tsd_status.id
  where 
  bitand(tsd_status.bit_flag,8192)=8192 --replace with Report status = Live & Customer status = Active
  and tsd_status.last_tx_date_time is not null
  and "Week-Ending Date" between (dateadd('day',-34,getdate())) and (dateadd('day',-7,getdate())) --exclude week prior from current week, ensure 4 weeks of IRI & MSA files for each store
  order by "Store ID" asc
